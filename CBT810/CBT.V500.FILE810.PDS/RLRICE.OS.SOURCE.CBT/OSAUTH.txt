* ------------------------------------------------------------------- *
*                                                                     *
*  MODULE NAME: OSAUTH                                                *
*                                                                     *
*  Dynamic authorization/de-authorization                             *
*                                                                     *
* ------------------------------------------------------------------- *
OSAUTH   CSECT
OSAUTH   AMODE 31
OSAUTH   RMODE ANY
         USING OSCOMM,R12
         USING SESSION,R11
         USING OSAUTH,R15
         B     INIT0000
MODID    DC    CL8'OSAUTH'
         DC    CL8'&SYSDATE'
         DC    CL8'&SYSTIME'
         DC    A(AUTHEND-OSAUTH)
INIT0000 DS    0H
         STM   R14,R12,12(R13)                SAVE REGISTERS
         LR    R10,R15                        COPY BASE ADDRESS
         DROP  R15
         USING OSAUTH,R10
         L     R15,COMM_DXD                   DXD ADDRESS
         A     R15,DXD_START                  PLUS OFFSET
         ST    R13,4(,R15)
         ST    R15,8(,R13)
         LR    R13,R15                        COPY DXD AREA ADDRESS
         USING DXDAUTH,R13                    DEFINE WORK AREA BASE
         MVC   DXD_CSECT,MODID
* ------------------------------------------------------------------- *
*                                                                     *
* ------------------------------------------------------------------- *
         ITRACE ID=ENTRY
* ------------------------------------------------------------------- *
*                                                                     *
*        Verify user is allowed to use functions that require         *
*        APF authorization.                                           *
*                                                                     *
* ------------------------------------------------------------------- *

*        Add any code needed to verify the user should be allowed
*        to use functions that require APF authorization.

* ------------------------------------------------------------------- *
*                                                                     *
* ------------------------------------------------------------------- *
         TM    COMM_FLAGS,$COMM_AUTH_ON       TURN AUTH ON?
         BO    AUTH0010                       YES
         B     AUTH0020
* ------------------------------------------------------------------- *
*                                                                     *
* ------------------------------------------------------------------- *
AUTH0010 DS    0H
         ITRACE ID=AUTH_ON

*        Add code to turn on APF authorization

         B     EXIT0000
* ------------------------------------------------------------------- *
*                                                                     *
* ------------------------------------------------------------------- *
AUTH0020 DS    0H
         ITRACE ID=AUTH_OFF

*        Add code to turn off APF authorization

* ------------------------------------------------------------------- *
*                                                                     *
* ------------------------------------------------------------------- *
EXIT0000 DS    0H
         ITRACE ID=EXIT
         L     R13,4(,R13)                    RESTORE SAVE AREA
         LM    R14,R12,12(R13)                RESTORE REGISTERS
         SR    R15,R15                        SET RC
         BR    R14                            RETURN
* ------------------------------------------------------------------- *
*                                                                     *
* ------------------------------------------------------------------- *
DXD_START      DC  Q(DXDAUTH)

AUTHEND        EQU   *
* ------------------------------------------------------------------- *
*                                                                     *
* ------------------------------------------------------------------- *
DXDAUTH        DSECT
               COPY  DXDPREF


*       add any work area you need here


* ------------------------------------------------------------------- *
*                                                                     *
* ------------------------------------------------------------------- *
               COMMON
* ------------------------------------------------------------------- *
*                                                                     *
* ------------------------------------------------------------------- *
               SESSION  TYPE=DSECT
* ------------------------------------------------------------------- *
*                                                                     *
* ------------------------------------------------------------------- *
               BPXYSTAT DSECT=YES,LIST=YES
* ------------------------------------------------------------------- *
*                                                                     *
* ------------------------------------------------------------------- *
               COPY TRENTRY
* ------------------------------------------------------------------- *
*                                                                     *
* ------------------------------------------------------------------- *
               COPY REGEQU
$BUFFSIZE      EQU  65535
               END  OSAUTH
