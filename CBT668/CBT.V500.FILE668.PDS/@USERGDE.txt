*PROGRAM: OFFLOAD
*PURPOSE: OFFLOAD JES 2 SPOOL DATASETS INTO MVS DATASET.
*AUTHOR : Hunter Guanghui Zhou
*         Phone: 1-(416)-602-9567
*         E-mail: zhough2000@yahoo.com
*LAST UPDATE: FEBRUARY, 2004
*
* DESCRIPTION
* ===========
*   GET THE GIVEN DATASET, SELECTED BY CRITERIA SET BY OPTION,
*   SAVE SAVE EACH DATASET INTO A MVS DATASET WITH ONE RECORD
*   ADDED AT THE BEGINNING, WHICH IDENTIFY THE CHARACTERISTICS
*   OF THE DATASET.
*
* INSTALL THE PROGRAM
* ===================
*   THE LINK PARM MUST USE AC(1) TO USE AUTHORIZED FUNCTIONS.
*   THE LINKLIB (SYSLMOD DD) MUST BE IN APF AUTHORIZED LIST OF
*   SYS1.PARMLIB(PROGxx).
*
* //COMPILE EXEC ASMACL,PARM.L='AC(1)'
* //C.SYSIN   DD DISP=SHR,
* //     DSN=SP2487.ASM.SOURCE(OFFLOAD)         <== This Source Member
* //C.SYSLIB  DD DISP=SHR,DSN=SYS1.MACLIB
* //          DD DISP=SHR,DSN=SYS1.MODGEN
* //L.SYSLMOD DD DISP=SHR,DSN=SYS1.TEST.LINKLIB <== Must be APF LIBRARY
* //L.SYSIN   DD *
*  NAME OFFLOAD(R)
* /*
*
* PROGRAM LOGIC
* =============
*   1. Initialize the program
*      a. Initialize flags, open SYSPRINT DD
*      b. Initialize SSOB and SSS2
*      c. Read this task information
*      d. Show the welcome information
*
*   2. Parse the EXEC PARM
*      Read and parse all the parameters given in EXEC PARM.
*      If there is a error (syntax error), stop the program with RC=8
*      If there is no EXEC PARM or PARM=HELP, show the help message,
*         and stop the program.
*      If the parm is valid, continue the program.
*
*   4. Run the main program logic
*
*     a. reset the status
*     b. call ASKJES to get dataset from JES spool.
*     c. test the return codes
*        If there is no dataset, call WAITWORK to wait work.
*     d. If there is a dataset, process it.
*        The process of the job data as follows:
*       .The program will have scan all the datasets (DD) in
*        current JOB, get  the total records and maximum record
*        length, and calculate the track size to be allocated
*        for output dataset.
*
*       . The program will then allocate the output dataset.
*       . The program will read all the datasets in this JOB output.
*       . And put the JOF700I record at the beginning of each data
*         set.
*      e. When current JOB output is processed, jump to step b.
*      f. If the wait work returns,
*         If the returned event is SAPI, then jump to step b to
*         call ASKJES.
*         If the returned even is STOP command, then exit the main
*         program logic.
*   5. If the program is required to stop, show the end message,
*      and unallocate storage, close SYSPRINT, and stop the program.
***********************************************************************
*
*
*                    PROGRAM HELP MESSAGE
*                    ====================
*
* Program    : OFFLOAD
* Description: JES Spool Offload Program.
* Purpose    : Offload JES Spool Data to cataloged dataset.
* Design     : Hunter Guanghui Zhou
* Support    : Phone: 1-(416)-602-9567
*              E-mail: zhough2000@yahoo.com
* Last Update: February, 2004
*
* Introduction
* ============
*
* This program will offload the JES spool datasets into system
* datasets. The program is designed based on following rules:
*
* 1. Each spool entry will be saved into one cataloged system dataset.
*    Only spool data in OUTPUT queue will be processed.
* 2. The system cataloged dataset name convention are:
*    hlq.jobname.Ddate.jobid.TtimeIid
*
*   Here:
*   hlq      The high level qualifier of the offloaded spool dataset.
*            This hlq must given as 'H=hlq' in EXEC PARM.
*   jobname  The job name of the spool dataset.
*   date     The date when the spool dataset is created.
*   jobid    The job id of the spool dataset.
*   time     The time when the spool dataset is created.
*   id       The sequence number automatic generated by program.
*            When there are multiple spool datasets generated by
*            JES batches, the id will be added from 01 to 99.
*
* 3. All spool datasets in a single spool entry will be saved
*    into single dataset.
*    For example, JCL batch logs normally contain following 3 DDNAME
*        JESMSGLG, JESJCL, JESYSMSG
*    The program will merge these DDNAMEs in joblog into a cataloged
*    system dataset.
*
* 4. There will be a extra record at the beginning of each DDNAME.
*    To distinguish each DDNAMEs, the program add one record at
*    the beginning of the data. Here is the format of this record
*
* ****JOF700I JOBNAME(jobname ),JOBID(jobid   ),DDNAME(ddname  )****
*        RECORDS(#records)**
*
*    Here the jobname, jobid, ddname and number of records will be
*    updatedd according to related information of the spool dataset.
*
* 5. If there is any problem while processing one spool data,
*    the spool data will be in SYSTEM hold. You should refer
*    the program logs to get more information.
*
*
* Explanation of EXEC PARM
* ========================
*
*   The spool data can be selected by criteria given in EXEC PARM.
* All options in EXEC PARM can be in any order.
* The syntax of option are:
*      key1=value1,key2=value2
* Here key is single letter keyword, and value is the actual criteria
* for that key.
* If you specify multiple criteria, the selected spool data will meet
* all criteria.
*
*
* 1. H=higher level qualifier
*    This is mandatory option to specify the higher level qualifier
*    to be used to create cataloged system datasets, maximum in
*    8 characters.
*    Example:
*        H=LOGS                 Use LOGS as HLQ (LOGS.jobname.Ddat
*     Use LOGS as higher level qualifier, the datasets will be:
*        LOGS.jobname.Ddate.jobid.TtimeIid
*
* 2. C=classes
*    This specify the SYSOUT class selection criteria. You can
*    specify up to 36 classes in this option. The classes ranges
*    from 0-9, and A-Z.
*    Example:
*        C=A                    Just select SYSOUT class A
*        C=0123456789           Select SYSOUT class in numbers
*        C=ASHJ                 Select SYSOUT class A,S,H and J
*
* 3. D=dest
*    This specify the SYSOUT DEST selection criteria, maximum
*    8 characters.
*    If this is not specified, the DEST=LOCAL will be used.
*    This option support wildcards. use * for multiple characters
*    and ? for single character.
*    Example:
*        D=OFFLOAD              Just select SYSOUT DEST=OFFLOAD
*
* 4. F=form
*    This specify the SYSOUT FORM selection criteria, maximum
*    8 characters.
*    If this is not specified, any FORM will be selected.
*    This option support wildcards. use * for multiple characters
*    and ? for single character.
*    Example:
*        F=OFFLOAD              Just select SYSOUT FORM=OFFLOAD
*
* 5. J=jobname
*    This specify the jobname as selection criteria, maximum
*    8 characters.
*    If this is not specified, any jobname will be selected.
*    This option support wildcards. use * for multiple characters
*    and ? for single character.
*    Example:
*        J=EDI*                 Select jobname starts with EDI
*
* 6. HELP or no EXEC PARM at all.
*    When you specify HELP or do not specify EXEC PARM, this help
*    message will be shown.
*
*    Example:
*     1).//OFFLOAD EXEC PGM=OFFLOAD
*
*     2).//OFFLOAD EXEC PGM=OFFLOAD,PARM=HELP
*
*
* EXEC PARM Examples
* ------------------
*   1). Select spool data with SYSOUT class in numbers
*       and use 'LOGS' as higher level qualifier.
*
*        //OFFLOAD EXEC PGM=OFFLOAD,
*        //        PARM='H=LOGS,C=0123456789'
*        //SYSPRINT DD SYSOUT=*
*
*   2). Select spool data with USERID is SP2487, jobname starts
*       with SP2487, and use 'SP2487' as higher level qualifier.
*
*        //OFFLOAD EXEC PGM=OFFLOAD,
*        //        PARM='H=SP2487,U=SP2487,J=SP2487*'
*        //SYSPRINT DD SYSOUT=*
*
*   3). Select spool data with USERID is SP2487, jobname starts
*       with SP2487, and use 'SP2487' as higher level qualifier.
*
*        //OFFLOAD EXEC PGM=OFFLOAD,
*        //        PARM=('H=LOGS,U=OP9999*',
*        //        'C=159CX,D=OFFLOAD')
*        //SYSPRINT DD SYSOUT=*
*
*
* Program Logs in SYSPRINT
* ========================
*   The processing logs can be shown in SYSPRINT DD. If SYSPRINT DD
*   is not presented in JCL, there is no logs generated.
*
*   The requirements of SYSPRINT:
*      LRECL=133,RECFM=FBA
*
*   You may just specify following statement in JCL:
*        //SYSPRINT DD SYSOUT=*
*
*
* OPERATION
* =========
*   START
*   -----
*   You can start the program in JCL batch or started task.
*   Sample JCL to start:
*
*        //jobcard here
*        //OFFLOAD EXEC PGM=OFFLOAD,
*        //        PARM='your parms here'
*        //SYSPRINT DD SYSOUT=*
*
*   STOP
*   ----
*   The program support MVS system STOP command.
*   Example, if the jobname of this program is JOFLD00,
*   Use following MVS system command to stop it:
*      P JOFLD00
*
* Support
* =======
*
*  The program is written in assembler for high performance.
*  If there is a bug or problem, please contact:
*       Hunter Guanghui Zhou
*       Phone: 1-(416)-602-9567
*       E-mail: zhough2000@yahoo.com
*
